parameters:
  - name: numberOfDaysRetainment
    type: string
    default: 365
    displayName: 'Number of days to retain the build'
  - name: displayName
    type: string
    default: 'Execute scan with retries'
    displayName: 'Retain Build if succeeded'

steps:
  - powershell: |
      $isReleaseTag = $($env:BUILD_SOURCEBRANCH -like 'refs/tags/v*')
      Write-Host "isReleaseTag: $isReleaseTag"
      Write-Host "##vso[task.setvariable variable=isReleaseTag]$isReleaseTag"
    displayName: 'Check if release'

  - task: PowerShell@2
    condition: and(and(succeeded(), not(canceled())), eq(variables['isReleaseTag'], true))
    displayName: ${{ parameters.displayName }}
    inputs:
      failOnStderr: true
      targetType: 'inline'
      script: |
        $contentType = "application/json";
        $headers = @{ Authorization = 'Bearer $(System.AccessToken)' };
        $rawRequest = @{ daysValid = ${{ parameters.numberOfDaysRetainment }}; definitionId = $(System.DefinitionId); ownerId = 'User:$(Build.RequestedForId)'; protectPipeline = $false; runId = $(Build.BuildId) };
        $request = ConvertTo-Json @($rawRequest);
        $uri = "$(System.CollectionUri)$(System.TeamProject)/_apis/build/retention/leases?api-version=6.0-preview.1";
        Invoke-RestMethod -uri $uri -method POST -Headers $headers -ContentType $contentType -Body $request;
